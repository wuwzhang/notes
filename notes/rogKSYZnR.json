{"title":"通过iframe引入加密狗登录","content":"通过iframe引入加密狗登录\n===\n## 功能需求\n- 使用`iframe`将加密狗登录页面引入到`React`原有项目中，实现一站式登录\n## 流程\n- 浏览器安装插件\n- 获取`authcode`\n- `chrome`下监听`SNTL_FROM_HOST`，获取用户名\n- 用户输入密码\n- 验证密码\n- 获得`token`，发送消息给父框架请求登录\n- 父框架接收消息，返回给子框架`grant`授权\n- 通过`token`获取`access_token`并发送给父框架\n- 父框架设置`access_token`\n## 遇到的问题\n- 如何在`react`项目中引入`iframe`并发送监听事件\n- 父子框剪之间如何消息传递\n- 如何跨域监听消息\n\n## 实现\n### react中引入iframe\n```jsx\nclass Login extends Component {\n  send(data, url) {\n    if (this.Login && this.Login.contentWindow) {\n      this.container.contentWindow.postMessage(data, url);\n    }\n  }\n  componentDidMount() {\n    window.addEventListener('message', e => {\n      ...\n    });\n  }\n  render() {\n    return (\n      <section>\n        <iframe \n          src=\"http://*****\"    //子框架地址\n          ref={ e => { this.Login = e; } }\n          height=\"190\"\n          width='300'\n          frameBorder=\"0\"\n        ></iframe>\n      </section>\n    )\n  } \n}\n\n```\n### 消息传递\n```js\n//子框架\n\n//消息发送\n// GetUserNameEx\nAuthObject.prototype.GetUserNameEx = function (scope, authCode) {\n    window.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetUserNameEx\", \"Scope\": scope, \"AuthCode\": authCode} }, \"*\");\n    return 0;\n};\n\n// GetDigestEx\nAuthObject.prototype.GetDigestEx = function (scope, authCode, password, challenge) {\n    //console.log(\"enter GetDigestEx()\");\n    window.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetDigestEx\", \"Scope\": scope, \"AuthCode\": authCode, \"UserPin\": password, \"Challenge\": challenge} }, \"*\");\n    return 0;\n};\n\n//消息监听\nwindow.addEventListener(\"message\", function(event) {\n  if (event.source !== window) return;\n  if (event.data.type === \"SNTL_FROM_HOST\") {\n    var ReturnText = event.data.text;\n    if (\"GetUserNameEx\" === ReturnText.InvokeMethod) {\n      ...\n    } else if (\"GetDigestEx\" === ReturnText.InvokeMethod) {\n      ...\n    } else {\n      return;\n    }\n  }\n}\n```\n\n- **然而！**这样监听不到消息，原因是应该向父级发送消息\n\n```js\n//子框架\n\n//消息发送\n// GetUserNameEx\nAuthObject.prototype.GetUserNameEx = function (scope, authCode) {\n    - window.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetUserNameEx\", \"Scope\": scope, \"AuthCode\": authCode} }, \"*\");\n    + window.parent.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetUserNameEx\", \"Scope\": scope, \"AuthCode\": authCode} }, \"*\");\n    return 0;\n};\n\n// GetDigestEx\nAuthObject.prototype.GetDigestEx = function (scope, authCode, password, challenge) {\n    //console.log(\"enter GetDigestEx()\");\n    - window.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetDigestEx\", \"Scope\": scope, \"AuthCode\": authCode, \"UserPin\": password, \"Challenge\": challenge} }, \"*\");\n    + window.parent.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetDigestEx\", \"Scope\": scope, \"AuthCode\": authCode, \"UserPin\": password, \"Challenge\": challenge} }, \"*\");\n    return 0;\n};\n\n//消息监听\n- window.addEventListener(\"message\", function(event) {\n+ window.parent.addEventListener(\"message\", function(event) {\n  - if (event.source !== window) return;\n  if (event.data.type === \"SNTL_FROM_HOST\") {\n    var ReturnText = event.data.text;\n    if (\"GetUserNameEx\" === ReturnText.InvokeMethod) {\n      ...\n    } else if (\"GetDigestEx\" === ReturnText.InvokeMethod) {\n      ...\n    } else {\n      return;\n    }\n  }\n}\n```\n- **然而！！还是不行**，报错`Uncaught DOMException: Blocked a frame with origin “http://***” from accessing a cross-origin frame`,无法跨域使用`window.parent.addEventListener`，但能在父框架监听到`SNTL_FROM_PAGE`消息\n- 最后的最后，感谢后台小哥提点，在父框架下消息转发，解决问题：）\n\n```js\n//子框架\n//消息发送\n// GetUserNameEx\nwindow.parent.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetUserNameEx\", \"Scope\": scope, \"AuthCode\": authCode} }, \"*\");\n// GetDigestEx\nwindow.parent.postMessage({ type: \"SNTL_FROM_PAGE\", text: { \"InvokeMethod\": \"GetDigestEx\", \"Scope\": scope, \"AuthCode\": authCode, \"UserPin\": password, \"Challenge\": challenge} }, \"*\");\n//消息监听\nwindow.addEventListener\n\n\n//父框架\ncomponentDidMount() {\n  ...\n  window.addEventListener('message', e => {\n    switch (e.data.type) {\n      case \"SNTL_FROM_HOST\":\n        send(...e.data, 'http://****')\n    }\n  });\n}\n```","tags":[],"folderPathname":"/font","data":{},"createdAt":"2020-08-07T02:48:48.620Z","updatedAt":"2020-08-07T02:48:56.163Z","trashed":false,"_id":"note:rogKSYZnR","_rev":"3-2f955af1e0e25d15bd746bf6586fb541"}