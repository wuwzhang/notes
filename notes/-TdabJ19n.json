{"_id":"note:-TdabJ19n","title":"react-router","content":"## [ã€Œæºç è§£æ ã€è¿™ä¸€æ¬¡å½»åº•å¼„æ‡‚react-routerè·¯ç”±åŸç†](https://juejin.cn/post/6886290490640039943)\n### ä¸€ã€æ­£ç¡®ç†è§£`react-router`\n#### å•é¡µé¢åº”ç”¨\nå•é¡µé¢åº”ç”¨æ˜¯ä½¿ç”¨ä¸€ä¸ª`html`ä¸‹ï¼Œä¸€æ¬¡æ€§åŠ è½½`js`, `css`ç­‰èµ„æºï¼Œæ‰€æœ‰é¡µé¢éƒ½åœ¨ä¸€ä¸ªå®¹å™¨é¡µé¢ä¸‹ï¼Œé¡µé¢åˆ‡æ¢å®è´¨æ˜¯ç»„ä»¶çš„åˆ‡æ¢\n\n![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a08f0155b494fd7bb3bdcb12104c060~tplv-k3u1fbpfcp-watermark.image)\n\n#### æ­£ç¡®ç†è§£`react-router`\n##### `react-router-dom`å’Œ`react-router`å’Œ`history`åº“ä¸‰è€…ä»€ä¹ˆå…³ç³»\n- history \n  - å¯ä»¥ç†è§£ä¸º`react-router`çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æ•´ä¸ªè·¯ç”±åŸç†çš„æ ¸å¿ƒ\n  - é‡Œé¢é›†æˆäº†`popState`,`history.pushState`ç­‰åº•å±‚è·¯ç”±å®ç°çš„åŸç†æ–¹æ³•\n- react-router\n  - å¯ä»¥ç†è§£ä¸ºæ˜¯`react-router-dom`çš„æ ¸å¿ƒ\n  - é‡Œé¢å°è£…äº†`Router`ï¼Œ`Route`ï¼Œ`Switch`ç­‰æ ¸å¿ƒç»„ä»¶\n  - å®ç°äº†ä»è·¯ç”±çš„æ”¹å˜åˆ°ç»„ä»¶çš„æ›´æ–°çš„æ ¸å¿ƒåŠŸèƒ½,åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åªè¦ä¸€æ¬¡æ€§å¼•å…¥`react-router-dom`å°±å¯ä»¥äº†\n- react-router-dom\n  - åœ¨`react-router`çš„æ ¸å¿ƒåŸºç¡€ä¸Šï¼Œæ·»åŠ äº†ç”¨äºè·³è½¬çš„`Link`ç»„ä»¶ï¼Œå’Œ`histoy`æ¨¡å¼ä¸‹çš„`BrowserRouter`å’Œ`hash`æ¨¡å¼ä¸‹çš„`HashRouterç»„ä»¶ç­‰`ã€‚\n  - æ‰€è°“`BrowserRouter`å’Œ`HashRouter`ï¼Œä¹Ÿåªä¸è¿‡ç”¨äº†`history`åº“ä¸­`createBrowserHistory`å’Œ`createHashHistory`æ–¹æ³•\n\n```jsx\nimport { BrowserRouter as Router, Switch, Route, Redirect,Link } from 'react-router-dom'\n\nimport Detail from '../src/page/detail'\nimport List from '../src/page/list'\nimport Index from '../src/page/home/index'\n\nconst menusList = [\n  {\n    name: 'é¦–é¡µ',\n    path: '/index'\n  },\n  {\n    name: 'åˆ—è¡¨',\n    path: '/list'\n  },\n  {\n    name: 'è¯¦æƒ…',\n    path: '/detail'\n  },\n]\nconst index = () => {\n  return <div>\n    <div>\n     \n      <Router>\n      <div>{\n        /* link è·¯ç”±è·³è½¬ */\n         menusList.map(router=><Link key={router.path} to={ router.path } >\n           <span className=\"routerLink\" >{router.name}</span>\n         </Link>)\n      }</div>\n        <Switch>\n          <Route path={'/index'} component={Index} ></Route>\n          <Route path={'/list'} component={List} ></Route>\n          <Route path={'/detail'} component={Detail} ></Route>\n          {/*  è·¯ç”±ä¸åŒ¹é…ï¼Œé‡å®šå‘åˆ°/index  */}\n          <Redirect from='/*' to='/index' />\n        </Switch>\n      </Router>\n    </div>\n  </div>\n}\n```\n![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3eac570169a4480598001f601ef374d5~tplv-k3u1fbpfcp-watermark.image)\n### å•é¡µé¢å®ç°æ ¸å¿ƒåŸç†\nå•é¡µé¢åº”ç”¨è·¯ç”±å®ç°åŸç†æ˜¯ï¼Œåˆ‡æ¢`url`ï¼Œç›‘å¬`url`å˜åŒ–ï¼Œä»è€Œæ¸²æŸ“ä¸åŒçš„é¡µé¢ç»„ä»¶ã€‚\n\nä¸»è¦çš„æ–¹å¼æœ‰`history`æ¨¡å¼å’Œ`hash`æ¨¡å¼ã€‚\n\n### äºŒã€å•é¡µé¢å®ç°åŸç†\n#### `history`æ¨¡å¼åŸç†\n1. æ”¹å˜è·¯ç”±\n##### `history.pushState`\n```js\nhistory.pushState(state, title, path)\n```\n- `state`: ä¸€ä¸ªä¸æŒ‡å®šç½‘å€ç›¸å…³çš„çŠ¶æ€å¯¹è±¡ï¼Œ`popstate`äº‹ä»¶è§¦å‘æ—¶ï¼Œè¯¥å¯¹è±¡ä¼šä¼ å…¥å›è°ƒå‡½æ•°ã€‚å¦‚æœä¸éœ€è¦å¯å¡«`null`\n- `title`ï¼šæ–°é¡µé¢çš„æ ‡é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰æµè§ˆå™¨ç›®å‰éƒ½å¿½ç•¥è¿™ä¸ªå€¼ï¼Œå¯å¡«`null`\n- `path`ï¼šæ–°çš„ç½‘å€ï¼Œå¿…é¡»ä¸å½“å‰é¡µé¢å¤„åœ¨åŒä¸€ä¸ªåŸŸã€‚æµè§ˆå™¨çš„åœ°å€æ å°†æ˜¾ç¤ºè¿™ä¸ªåœ°å€ã€‚\n- `path`ï¼šæ–°çš„ç½‘å€ï¼Œå¿…é¡»ä¸å½“å‰é¡µé¢å¤„åœ¨åŒä¸€ä¸ªåŸŸã€‚æµè§ˆå™¨çš„åœ°å€æ å°†æ˜¾ç¤ºè¿™ä¸ªåœ°å€ã€‚\n\n###### `history.replaceState`\n```js\nhistory.replaceState(state, title, path)\n```\nå‚æ•°å’Œ`pushState`ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹å½“å‰çš„`history`å¯¹è±¡è®°å½•ï¼Œ `history.length`çš„é•¿åº¦ä¸ä¼šæ”¹å˜ã€‚\n\n2. ç›‘å¬è·¯ç”±\n###### `popstate`äº‹ä»¶\n```js\nwindow.addEventListener('popstate', function(e) {\n  /* ç›‘å¬æ”¹å˜ */\n})\n```\nåŒä¸€ä¸ªæ–‡æ¡£çš„`history`å¯¹è±¡å‡ºç°å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘`popstate`äº‹ä»¶\n\n- `history.pushState`å¯ä»¥ä½¿æµè§ˆå™¨åœ°å€æ”¹å˜ï¼Œä½†æ˜¯æ— éœ€åˆ·æ–°é¡µé¢ã€‚\n- æ³¨æ„âš ï¸çš„æ˜¯ï¼šç”¨`history.pushState()`æˆ–è€…`history.replaceState()`ä¸ä¼šè§¦å‘`popstate`äº‹ä»¶ã€‚\n- `popstate`äº‹ä»¶åªä¼šåœ¨æµè§ˆå™¨æŸäº›è¡Œä¸ºä¸‹è§¦å‘, æ¯”å¦‚\n  - åé€€æŒ‰é’®\n  - å‰è¿›æŒ‰é’®\n  - `history.back()`\n  - `history.forward()`\n  - `history.go()`\n\n#### `hash`æ¨¡å¼åŸç†\n1. æ”¹å˜è·¯ç”±\n##### `window.location.hash`\né€šè¿‡`window.location.hash`å±æ€§è·å–å’Œè®¾ç½®`hash`å€¼ã€‚\n2. ç›‘å¬è·¯ç”±\n##### `onhashchange`\n```js\nwindow.addEventListener('hashchange', function(e) {\n    /* ç›‘å¬æ”¹å˜ */\n})\n```\n\n### ä¸‰ã€ç†è§£`history`åº“\n`react-router`è·¯ç”±ç¦»ä¸å¼€`history`åº“ï¼Œ`history`ä¸“æ³¨äºè®°å½•è·¯ç”±`history`çŠ¶æ€ï¼Œä»¥åŠ`path`æ”¹å˜äº†ï¼Œæˆ‘ä»¬åº”è¯¥**åšäº›ä»€ä¹ˆ**ï¼Œåœ¨`history`æ¨¡å¼ä¸‹ç”¨`popstate`ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œåœ¨`hash`æ¨¡å¼ä¸‹ç”¨`hashchange`ç›‘å¬è·¯ç”±çš„å˜åŒ–ã€‚\n\n#### 1. `createBrowserHistory`\n\n`Browser`æ¨¡å¼ä¸‹è·¯ç”±çš„è¿è¡Œ ï¼Œä¸€åˆ‡éƒ½ä»`createBrowserHistory`å¼€å§‹ã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒçš„`history-4.7.2`ç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸­`api`å¯èƒ½æœ‰äº›å‡ºå…¥ï¼Œä½†æ˜¯åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåœ¨è§£æ`history`è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨`setState`ã€`push`ã€`handlePopState`ã€`listen`æ–¹æ³•\n\n```js\nconst PopStateEvent = 'popstate'\nconst HashChangeEvent = 'hashchange'\n/* è¿™é‡Œç®€åŒ–äº†createBrowserHistoryï¼Œåˆ—å‡ºäº†å‡ ä¸ªæ ¸å¿ƒapiåŠå…¶ä½œç”¨ */\nfunction createBrowserHistory(){\n    /* å…¨å±€history  */\n    const globalHistory = window.history\n    /* å¤„ç†è·¯ç”±è½¬æ¢ï¼Œè®°å½•äº†listensä¿¡æ¯ã€‚ */\n    const transitionManager = createTransitionManager()\n    /* æ”¹å˜locationå¯¹è±¡ï¼Œé€šçŸ¥ç»„ä»¶æ›´æ–° */\n    const setState = () => { /* ... */ }\n    \n    /* å¤„ç†å½“pathæ”¹å˜åï¼Œå¤„ç†popstateå˜åŒ–çš„å›è°ƒå‡½æ•° */\n    const handlePopState = () => { /* ... */ }\n   \n    /* history.pushæ–¹æ³•ï¼Œæ”¹å˜è·¯ç”±ï¼Œé€šè¿‡å…¨å±€å¯¹è±¡history.pushStateæ”¹å˜url, é€šçŸ¥routerè§¦å‘æ›´æ–°ï¼Œæ›¿æ¢ç»„ä»¶ */\n    const push=() => { /*...*/ }\n    \n    /* åº•å±‚åº”ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬popstateäº‹ä»¶ */\n    const listen=()=>{ /*...*/ } \n    return {\n       push,\n       listen,\n       /* .... */ \n    }\n}\n```\n\nä¸‹é¢é€ä¸€åˆ†æå„ä¸ª`api`, å’Œä»–ä»¬ä¹‹å‰çš„ç›¸äº’ä½œç”¨\n```js\nconst PopStateEvent = 'popstate'\nconst HashChangeEvent = 'hashchange'\n```\n`popstate`å’Œ`hashchange`æ˜¯ç›‘å¬è·¯ç”±å˜åŒ–åº•å±‚æ–¹æ³•ã€‚\n\n##### 1. `setState`\n```jsx\nconst setState = (nextState) => {\n    /* åˆå¹¶ä¿¡æ¯ */\n  Object.assign(history, nextState)\n  history.length = globalHistory.length\n  /* é€šçŸ¥æ¯ä¸€ä¸ªlistens è·¯ç”±å·²ç»å‘ç”Ÿå˜åŒ– */\n  transitionManager.notifyListeners(\n    history.location,\n    history.action\n  )\n}\n```\n\nä»£ç å¾ˆç®€å•ï¼šç»Ÿä¸€æ¯ä¸ª`transitionManager`ç®¡ç†çš„`listener`è·¯ç”±çŠ¶æ€å·²ç»æ›´æ–°ã€‚\n\nä»€ä¹ˆæ—¶å€™ç»‘å®š`litener`ï¼Œ æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„`React-Router`ä»£ç ä¸­ä¼šä»‹ç»ã€‚\n\n##### 2. `listen`\n\n```js\nconst listen = (listener) => {\n    /* æ·»åŠ listen */\n    const unlisten = transitionManager.appendListener(listener)\n    checkDOMListeners(1)\n\n    return () => {\n      checkDOMListeners(-1)\n      unlisten()\n    }\n}\n```\n\n###### checkDOMListeners\n```js\nconst checkDOMListeners = delta => {\n  listenerCount += delta\n  if (listenerCount === 1) {\n    addEventListener(window, PopStateEvent, handlePopState)\n    if (needsHashChangeListener) { addEventListener(window, HashChangeEvent, handleHashChange) }\n  } else if (listenerCount === 0) {\n    removeEventListener(window, PopStateEvent, handlePopState)\n    if (needsHashChangeListener) { removeEventListener(window, HashChangeEvent, handleHashChange) }\n  }\n}\n```\n\n##### 3. `push`\n```jsx\nconst push = (path, state) => {\n  const action = 'PUSH'\n  /* 1 åˆ›å»ºlocationå¯¹è±¡ */\n  const location = createLocation(path, state, createKey(), history.location)\n  /* ç¡®å®šæ˜¯å¦èƒ½è¿›è¡Œè·¯ç”±è½¬æ¢ï¼Œè¿˜åœ¨ç¡®è®¤çš„æ—¶å€™åˆå¼€å§‹äº†å¦ä¸€ä¸ªè½¬å˜ ,å¯èƒ½ä¼šé€ æˆå¼‚å¸¸ */\n  transitionManager.confirmTransitionTo(location, action, getUserConfirmation, ok => {\n    if (!ok) { return }\n    const href = createHref(location)\n    const { key, state } = location\n    if (canUseHistory) {\n      /* æ”¹å˜ url */\n      globalHistory.pushState({ key, state }, null, href)\n      if (forceRefresh) {\n        window.location.href = href\n      } else {\n        /* æ”¹å˜ react-router locationå¯¹è±¡, åˆ›å»ºæ›´æ–°ç¯å¢ƒ */\n        setState({ action, location })\n      }\n    } else {\n      window.location.href = href\n    }\n  })\n}\n```\n`push(history.push)`æµç¨‹å¤§è‡´æ˜¯ \n- é¦–å…ˆç”Ÿæˆä¸€ä¸ªæœ€æ–°çš„`location`å¯¹è±¡\n- ç„¶åé€šè¿‡`window.history.pushState`æ–¹æ³•æ”¹å˜æµè§ˆå™¨å½“å‰è·¯ç”±(å³å½“å‰çš„`path`)\n- æœ€åé€šè¿‡`setState`æ–¹æ³•é€šçŸ¥`React-Router`æ›´æ–°ï¼Œå¹¶ä¼ é€’å½“å‰çš„`location`å¯¹è±¡\n\nç”±äºè¿™æ¬¡`url`å˜åŒ–çš„ï¼Œæ˜¯`history.pushState`äº§ç”Ÿçš„ï¼Œå¹¶ä¸ä¼šè§¦å‘`popState`æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨`setState`ï¼Œè§¦å‘ç»„ä»¶æ›´æ–°ã€‚\n\n##### 4. `handlePopState`\n\næœ€åæˆ‘ä»¬æ¥çœ‹çœ‹å½“`popState`ç›‘å¬çš„å‡½æ•°ï¼Œå½“`path`æ”¹å˜çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆ\n\n```js\n/* æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹handlePopState */\nconst handlePopState = (event)=>{\n     /* è·å–å½“å‰locationå¯¹è±¡ */\n    const location = getDOMLocation(event.state)\n    const action = 'POP'\n\n    transitionManager.confirmTransitionTo(location, action, getUserConfirmation, (ok) => {\n        if (ok) {\n          setState({ action, location })\n        } else {\n          revertPop(location)\n        }\n    })\n}\n```\n`handlePopState`ä»£ç å¾ˆç®€å• ï¼Œåˆ¤æ–­ä¸€ä¸‹`action`ç±»å‹ä¸º`pop`,ç„¶å`setState` ï¼Œä»æ–°åŠ è½½ç»„ä»¶ã€‚\n\n#### 2. `createHashHistory`\n`hash`æ¨¡å¼å’Œ`history API`ç±»ä¼¼ï¼Œæˆ‘ä»¬é‡ç‚¹è®²ä¸€ä¸‹`hash`æ¨¡å¼ä¸‹ï¼Œæ€ä¹ˆç›‘å¬è·¯ç”±ï¼Œå’Œ`push`, `replace`æ–¹æ³•æ˜¯æ€ä¹ˆæ”¹å˜æ”¹å˜è·¯å¾„çš„ã€‚\n\n##### ç›‘å¬å“ˆå¸Œè·¯ç”±å˜åŒ–\n```js\nconst HashChangeEvent = 'hashchange'\nconst checkDOMListeners = (delta) => {\n  listenerCount += delta\n  if (listenerCount === 1) {\n    addEventListener(window, HashChangeEvent, handleHashChange)\n  } else if (listenerCount === 0) {\n    removeEventListener(window, HashChangeEvent, handleHashChange)\n  }\n}\n```\n\nå’Œä¹‹å‰æ‰€è¯´çš„ä¸€æ ·ï¼Œå°±æ˜¯ç”¨`hashchange`æ¥ç›‘å¬`hash`è·¯ç”±çš„å˜åŒ–ã€‚\n\n##### æ”¹å˜å“ˆå¸Œè·¯ç”±\n```js\n\n/* å¯¹åº” push æ–¹æ³• */\nconst pushHashPath = (path) =>\n  window.location.hash = path\n\n/* å¯¹åº”replaceæ–¹æ³• */\nconst replaceHashPath = (path) => {\n  const hashIndex = window.location.href.indexOf('#')\n\n  window.location.replace(\n    window.location.href.slice(0, hashIndex >= 0 ? hashIndex : 0) + '#' + path\n  )\n}\n```\nåœ¨`hash`æ¨¡å¼ä¸‹ ï¼Œ`history.push`åº•å±‚æ˜¯è°ƒç”¨äº†`window.location.href`æ¥æ”¹å˜è·¯ç”±ã€‚`history.replace`åº•å±‚æ˜¯æ‰ç”¨`window.location.replace`æ”¹å˜è·¯ç”±ã€‚\n\n#### æ€»ç»“\næˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥æè¿°äº†ä¸€ä¸‹`history`åº“æ•´ä½“æµç¨‹ã€‚\n![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac7ed7a701714650b55c9193db2220ea~tplv-k3u1fbpfcp-watermark.image)\n\n### å››ã€æ ¸å¿ƒapi\n#### 1. `Router` - æ¥æ”¶`location`å˜åŒ–ï¼Œæ´¾å‘æ›´æ–°æµ\n`Router`ä½œç”¨æ˜¯æŠŠ`history location`ç­‰è·¯ç”±ä¿¡æ¯ä¼ é€’ä¸‹å»\n\n```jsx\n/* Router ä½œç”¨æ˜¯æŠŠ history location ç­‰è·¯ç”±ä¿¡æ¯ ä¼ é€’ä¸‹å»  */\nclass Router extends React.Component {\n  static computeRootMatch(pathname) {\n    return { path: '/', url: '/', params: {}, isExact: pathname === '/' };\n  }\n  constructor(props) {\n    super(props);\n    this.state = {\n      location: props.history.location\n    };\n    //è®°å½•pendingä½ç½®\n    //å¦‚æœå­˜åœ¨ä»»ä½•<Redirect>ï¼Œåˆ™åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œæ›´æ”¹\n    //åœ¨åˆå§‹æ¸²æŸ“æ—¶ã€‚å¦‚æœæœ‰ï¼Œå®ƒä»¬å°†åœ¨\n    //åœ¨å­ç»„ä»¶èº«ä¸Šæ¿€æ´»ï¼Œæˆ‘ä»¬å¯èƒ½ä¼š\n    //åœ¨å®‰è£…<Router>ä¹‹å‰è·å–ä¸€ä¸ªæ–°ä½ç½®ã€‚\n    this._isMounted = false;\n    this._pendingLocation = null;\n    /* æ­¤æ—¶çš„historyï¼Œæ˜¯historyåˆ›å»ºçš„historyå¯¹è±¡ */\n    if (!props.staticContext) {\n      /* è¿™é‡Œåˆ¤æ–­ componentDidMount å’Œ history.listen æ‰§è¡Œé¡ºåº ç„¶åæŠŠ locationå¤åˆ¶ ï¼Œé˜²æ­¢ç»„ä»¶é‡æ–°æ¸²æŸ“ */\n      this.unlisten = props.history.listen(location => {\n        /* åˆ›å»ºç›‘å¬è€… */\n        if (this._isMounted) {\n\n          this.setState({ location });\n        } else {\n          this._pendingLocation = location;\n        }\n      });\n    }\n  }\n  componentDidMount() {\n    this._isMounted = true;\n    if (this._pendingLocation) {\n      this.setState({ location: this._pendingLocation });\n    }\n  }\n  componentWillUnmount() {\n    /* è§£é™¤ç›‘å¬ */\n    if (this.unlisten) this.unlisten();\n  }\n  render() {\n    return (\n      /*  è¿™é‡Œå¯ä»¥ç†è§£ react.createContext åˆ›å»ºä¸€ä¸ª contextä¸Šä¸‹æ–‡ ï¼Œä¿å­˜routeråŸºæœ¬ä¿¡æ¯ã€‚children */\n      <RouterContext.Provider\n        children={this.props.children || null}\n        value={{\n          history: this.props.history,\n          location: this.state.location,\n          match: Router.computeRootMatch(this.state.location.pathname),\n          staticContext: this.props.staticContext\n        }}\n      />\n    );\n  }\n}\n```\n\næ€»ç»“ï¼š\n- åˆå§‹åŒ–ç»‘å®š`listen`, è·¯ç”±å˜åŒ–, é€šçŸ¥æ”¹å˜`location`, æ”¹å˜ç»„ä»¶ã€‚ \n- `react`çš„`history`è·¯ç”±çŠ¶æ€æ˜¯ä¿å­˜åœ¨`React.Content`ä¸Šä¸‹æ–‡ä¹‹é—´, çŠ¶æ€æ›´æ–°ã€‚\n- ä¸€ä¸ªé¡¹ç›®åº”è¯¥æœ‰ä¸€ä¸ªæ ¹`Router`ï¼Œæ¥äº§ç”Ÿåˆ‡æ¢è·¯ç”±ç»„ä»¶ä¹‹å‰çš„æ›´æ–°ä½œç”¨ã€‚\nå¦‚æœå­˜åœ¨å¤šä¸ª`Router`ä¼šé€ æˆï¼Œä¼šé€ æˆåˆ‡æ¢è·¯ç”±ï¼Œé¡µé¢ä¸æ›´æ–°çš„æƒ…å†µã€‚\n\n#### 2. `Switch` - åŒ¹é…æ­£ç¡®çš„å”¯ä¸€çš„è·¯ç”±\næ ¹æ®`router`æ›´æ–°æµï¼Œæ¥æ¸²æŸ“å½“å‰ç»„ä»¶ã€‚\n\n```js\n/* switchç»„ä»¶ */\nclass Switch extends React.Component {\n  render() {\n    return (\n      <RouterContext.Consumer>\n        {/* å«æœ‰ history location å¯¹è±¡çš„ context */}\n        {context => {\n          invariant(context, 'You should not use <Switch> outside a <Router>');\n          const location = this.props.location || context.location;\n          let element, match;\n          //æˆ‘ä»¬ä½¿ç”¨React.Children.forEachè€Œä¸æ˜¯React.Children.toArrayï¼ˆï¼‰.findï¼ˆï¼‰\n          //è¿™é‡Œæ˜¯å› ä¸ºtoArrayå‘æ‰€æœ‰å­å…ƒç´ æ·»åŠ äº†é”®ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›\n          //ä¸ºå‘ˆç°ç›¸åŒçš„ä¸¤ä¸ª<Route>sè§¦å‘å¸è½½/é‡æ–°è£…è½½\n          //ç»„ä»¶ä½äºä¸åŒçš„URLã€‚\n          //è¿™é‡Œåªéœ€ç„¶ç¬¬ä¸€ä¸ª å«æœ‰ match === null çš„ç»„ä»¶\n          React.Children.forEach(this.props.children, child => {\n            if (match == null && React.isValidElement(child)) {\n              element = child;\n              // å­ç»„ä»¶ ä¹Ÿå°±æ˜¯ è·å– Routeä¸­çš„ path æˆ–è€… rediect çš„ from\n              const path = child.props.path || child.props.from;\n              match = path\n                ? matchPath(location.pathname, { ...child.props, path })\n                : context.match;\n            }\n          });\n          return match\n            ? React.cloneElement(element, { location, computedMatch: match })\n            : null;\n        }}\n      </RouterContext.Consumer>\n    );\n  }\n}\n```\n\n- æ‰¾åˆ°ä¸å½“å‰`path`, åŒ¹é…çš„ç»„ä»¶è¿›è¡Œæ¸²æŸ“ã€‚ \n- é€šè¿‡`pathname`å’Œç»„ä»¶çš„`path`è¿›è¡ŒåŒ¹é…ã€‚\n- æ‰¾åˆ°ç¬¦åˆ`path`çš„`router`ç»„ä»¶ã€‚\n\n##### `matchPath`\n```jsx\nfunction matchPath(pathname, options = {}) {\n  if (typeof options === \"string\" || Array.isArray(options)) {\n    options = { path: options };\n  }\n\n  const { path, exact = false, strict = false, sensitive = false } = options;\n\n  const paths = [].concat(path);\n\n  return paths.reduce((matched, path) => {\n    if (!path && path !== \"\") return null;\n    if (matched) return matched;\n\n    const { regexp, keys } = compilePath(path, {\n      end: exact,\n      strict,\n      sensitive\n    });\n    const match = regexp.exec(pathname);\n    /* åŒ¹é…ä¸æˆåŠŸï¼Œè¿”å›null */\n    if (!match) return null;\n\n    const [url, ...values] = match;\n    const isExact = pathname === url;\n\n    if (exact && !isExact) return null;\n\n    return {\n      path, // the path used to match\n      url: path === \"/\" && url === \"\" ? \"/\" : url, // the matched portion of the URL\n      isExact, // whether or not we matched exactly\n      params: keys.reduce((memo, key, index) => {\n        memo[key.name] = values[index];\n        return memo;\n      }, {})\n    };\n  }, null);\n}\n```\nåŒ¹é…ç¬¦åˆçš„è·¯ç”±ã€‚\n\n#### 3. `Route` - ç»„ä»¶é¡µé¢æ‰¿è½½å®¹å™¨\n```jsx\n/**\n * The public API for matching a single path and rendering.\n */\nclass Route extends React.Component {\n  render() {\n    return (\n      <RouterContext.Consumer>\n        {context => {\n          /* router / route ä¼šç»™äºˆè­¦å‘Šè­¦å‘Š */\n          invariant(context, \"You should not use <Route> outside a <Router>\");\n          // computedMatch ä¸º ç»è¿‡ swichå¤„ç†åçš„ path\n          const location = this.props.location || context.location;\n          const match = this.props.computedMatch \n            ? this.props.computedMatch // <Switch> already computed the match for us\n            : this.props.path\n            ? matchPath(location.pathname, this.props)\n            : context.match;\n          const props = { ...context, location, match };\n          let { children, component, render } = this.props;\n\n          if (Array.isArray(children) && children.length === 0) {\n            children = null;\n          }\n\n          return (\n            <RouterContext.Provider value={props}>\n              {props.match\n                ? children\n                  ? typeof children === \"function\"\n                    ? __DEV__\n                      ? evalChildrenDev(children, props, this.props.path)\n                      : children(props)\n                    : children\n                  : component\n                  ? React.createElement(component, props)\n                  : render\n                  ? render(props)\n                  : null\n                : typeof children === \"function\"\n                ? __DEV__\n                  ? evalChildrenDev(children, props, this.props.path)\n                  : children(props)\n                : null}\n            </RouterContext.Provider>\n          );\n        }}\n      </RouterContext.Consumer>\n    );\n  }\n}\n```\n\n- åŒ¹é…`path`, æ¸²æŸ“ç»„ä»¶ã€‚\n- ä½œä¸ºè·¯ç”±ç»„ä»¶çš„å®¹å™¨, å¯ä»¥æ ¹æ®å°†å®é™…çš„ç»„ä»¶æ¸²æŸ“å‡ºæ¥ã€‚\n- é€šè¿‡`RouterContext.Consume`å–å‡ºå½“å‰ä¸Šä¸€çº§çš„`location`, `match`ç­‰ä¿¡æ¯ã€‚\n- ä½œä¸º`prop`ä¼ é€’ç»™é¡µé¢ç»„ä»¶ã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨é¡µé¢ç»„ä»¶ä¸­çš„`props`ä¸­è·å–`location`, `match`ç­‰ä¿¡æ¯ã€‚\n\n#### 4. `Redirect` - æ²¡æœ‰ç¬¦åˆçš„è·¯ç”±ï¼Œé‚£ä¹ˆé‡å®šå‘\né‡å®šå‘ç»„ä»¶ï¼Œ å¦‚æœæ¥è·¯ç”±åŒ¹é…ä¸Šï¼Œä¼šé‡å®šå‘å¯¹åº”çš„è·¯ç”±ã€‚\n\n```jsx\nfunction Redirect({ computedMatch, to, push = false }) {\n  return (\n    <RouterContext.Consumer>\n      {context => {\n        const { history, staticContext } = context;\n        /* methodå°±æ˜¯è·¯ç”±è·³è½¬æ–¹æ³•ã€‚ */\n        const method = push ? history.push : history.replace;\n        /* æ‰¾åˆ°ç¬¦åˆmatchçš„location ï¼Œæ ¼å¼åŒ–location */\n        const location = createLocation(\n          computedMatch\n            ? typeof to === 'string'\n              ? generatePath(to, computedMatch.params)\n              : {\n                  ...to,\n                  pathname: generatePath(to.pathname, computedMatch.params)\n                }\n            : to\n        )\n        /* åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œå½“åˆå§‹åŒ–çš„æ—¶å€™ï¼Œmountedæ‰§è¡Œpushæ–¹æ³•ï¼Œå½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœlocationä¸ç›¸ç­‰ã€‚åŒæ ·ä¼šæ‰§è¡Œhistoryæ–¹æ³•é‡å®šå‘ */\n        return (\n          <Lifecycle\n              onMount={() => {\n              method(location);\n            }}\n              onUpdate={(self, prevProps) => {\n              const prevLocation = createLocation(prevProps.to);\n              if (\n                !locationsAreEqual(prevLocation, {\n                  ...location,\n                  key: prevLocation.key\n                })\n              ) {\n                method(location);\n              } \n            }}\n              to={to}\n          />\n        );\n      }}\n    </RouterContext.Consumer>\n  );\n}\n```\nåˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œå½“åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ`mounted`æ‰§è¡Œ`push`æ–¹æ³•ï¼Œå½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœ`location`ä¸ç›¸ç­‰ã€‚åŒæ ·ä¼šæ‰§è¡Œ`history`æ–¹æ³•é‡å®šå‘\n\n### äº”ã€æ€»ç»“ + æµç¨‹åˆ†æ\n#### æ€»ç»“\n- `history`æä¾›äº†æ ¸å¿ƒ`api`ï¼Œå¦‚ç›‘å¬è·¯ç”±ï¼Œæ›´æ”¹è·¯ç”±çš„æ–¹æ³•ï¼Œå·²ç»ä¿å­˜è·¯ç”±çŠ¶æ€`state`ã€‚\n- `react-router`æä¾›è·¯ç”±æ¸²æŸ“ç»„ä»¶ï¼Œè·¯ç”±å”¯ä¸€æ€§åŒ¹é…ç»„ä»¶ï¼Œé‡å®šå‘ç»„ä»¶ç­‰åŠŸèƒ½ç»„ä»¶ã€‚\n#### æµç¨‹åˆ†æ\n##### å½“åœ°å€æ æ”¹å˜`url`ï¼Œç»„ä»¶çš„æ›´æ–°æ¸²æŸ“éƒ½ç»å†äº†ä»€ä¹ˆï¼ŸğŸ˜ŠğŸ˜ŠğŸ˜Š\n> æ‹¿`history`æ¨¡å¼åšå‚è€ƒã€‚\n\n- å½“`url`æ”¹å˜ï¼Œé¦–å…ˆè§¦å‘`histoy`ï¼Œè°ƒç”¨äº‹ä»¶ç›‘å¬`popstate`äº‹ä»¶ï¼Œ\n- è§¦å‘å›è°ƒå‡½æ•°`handlePopState`ï¼Œè§¦å‘`history`ä¸‹é¢çš„`setstate`æ–¹æ³•ï¼Œäº§ç”Ÿæ–°çš„`location`å¯¹è±¡ï¼Œ\n- ç„¶åé€šçŸ¥`Router`ç»„ä»¶æ›´æ–°`location`å¹¶é€šè¿‡`context`ä¸Šä¸‹æ–‡ä¼ é€’ï¼Œ\n- `switch`é€šè¿‡ä¼ é€’çš„æ›´æ–°æµï¼ŒåŒ¹é…å‡ºç¬¦åˆçš„`Route`ç»„ä»¶æ¸²æŸ“ï¼Œ\n- æœ€åæœ‰`Route`ç»„ä»¶å–å‡º`context`å†…å®¹ï¼Œä¼ é€’ç»™æ¸²æŸ“é¡µé¢ï¼Œæ¸²æŸ“æ›´æ–°ã€‚\n\n##### å½“æˆ‘ä»¬è°ƒç”¨`history.push`æ–¹æ³•ï¼Œåˆ‡æ¢è·¯ç”±ï¼Œç»„ä»¶çš„æ›´æ–°æ¸²æŸ“åˆéƒ½ç»å†äº†ä»€ä¹ˆå‘¢ï¼Ÿ\n> æˆ‘ä»¬è¿˜æ˜¯æ‹¿`history`æ¨¡å¼ä½œä¸ºå‚è€ƒ\n\n- å½“æˆ‘ä»¬è°ƒç”¨`history.push`æ–¹æ³•ï¼Œé¦–å…ˆè°ƒç”¨`history`çš„`push`æ–¹æ³•ï¼Œ\n- é€šè¿‡`history.pushState`æ¥æ”¹å˜å½“å‰`url`ï¼Œ\n- æ¥ä¸‹æ¥è§¦å‘`history`ä¸‹é¢çš„`setState`æ–¹æ³•ï¼Œ\n- æ¥ä¸‹æ¥çš„æ­¥éª¤å°±å’Œä¸Šé¢ä¸€æ¨¡ä¸€æ ·äº†ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€è¯´äº†ã€‚\n\næˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥è¡¨ç¤ºå„ä¸ªè·¯ç”±ç»„ä»¶ä¹‹é—´çš„å…³ç³»\n![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5de251f8dc649e3ae1b1fcf382330ee~tplv-k3u1fbpfcp-watermark.image)\n\nå¸Œæœ›è¯»è¿‡æ­¤ç¯‡æ–‡ç« çš„æœ‹å‹ï¼Œèƒ½å¤Ÿæ˜ç™½`react-router`çš„æ•´ä¸ªæµç¨‹ï¼Œä»£ç é€»è¾‘ä¸æ˜¯å¾ˆéš¾ç†è§£ã€‚æ•´ä¸ªæµç¨‹æˆ‘ç»™å¤§å®¶åˆ†æäº†ä¸€éï¼Œå¸Œæœ›åŒå­¦ä»¬èƒ½ä¸»åŠ¨çœ‹ä¸€æ³¢æºç ï¼ŒæŠŠæ•´ä¸ªæµç¨‹ææ˜ç™½ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…,ç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ","tags":[],"folderPathname":"/font/react","data":{},"createdAt":"2021-03-26T07:10:27.281Z","updatedAt":"2021-04-14T12:21:19.160Z","trashed":false,"_rev":"maQDNQYKR"}