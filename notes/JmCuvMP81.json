{"title":"Taro实践","content":"Taro实践\n==\n> 从临时接到任务要做一个答题微信小程序，为什么快速上手选用`Taro`到现在实践了3个小程序，也算是有些经验和总结，在此记录一下\n\n## 选择原因\n- 基于`React`语法规范，上手几乎0成本，满足基本开发需求\n  - 支持`TS`，支持` ES7/ES8`或更新的语法规范\n  - 支持`CSS`预编译器，`Sass/Less`等\n  - 支持`Hooks`(日常开发几乎不需要`redux`场景)\n  - 支持状态管理，`Redux/MobX`\n- 一套代码多端运行，开发成本低\n- `Taro UI`基于`Taro`开发的`UI`组件\n  - 支持多端`wechat`小程序 、`alipay`小程序、`tt`小程序、`H5`\n  - 组件丰富，API、文档友好\n  \n---\n\n## 开发准备\n```zsh\n# >=8.0.0\n$ yarn global add @tarojs/cli\n$ taro init myApp\n$ yarn\n```\n\n### 编译配置\n- `alias`\n```js\n// config/index\nalias: {\n  \"@/components\": \"src/components\",\n  \"@/utils\": \"src/utils\",\n  \"@/styles\": \"src/styles\",\n  \"@/apis\": \"src/apis\",\n  \"@/store\": \"src/store\",\n  \"@/images\": \"src/assets/images\"\n}\n```\n- 多端调试\n```js\n// config/index\noutputRoot: `dist/${process.env.TARO_ENV}`\n```\n- `Taro-UI`\n```js\n// config/index\nh5: {\n  esnextModules: ['taro-ui']\n}\n```\n- `CSS Module`\n```js\n// 小程序\nmini: {\n  postcss: {\n    // css modules 功能开关与相关配置\n    cssModules: {\n      enable: true, // 默认为 false，如需使用 css modules 功能，则设为 true\n      config: {\n        namingPattern: 'module', // 转换模式，取值为 global/module，下文详细说明\n        generateScopedName: '[name]__[local]___[hash:base64:5]'\n      }\n    }\n  }\n}\n\n// h5\nh5: {\n  postcss: {\n    // css modules 功能开关与相关配置\n    cssModules: {\n      enable: true, // 默认为 false，如需使用 css modules 功能，则设为 true\n      config: {\n        namingPattern: 'module', // 转换模式，取值为 global/module，下文详细说明\n        generateScopedName: '[name]__[local]___[hash:base64:5]'\n      }\n    }\n  }\n}\n\n// import styles from './style.scss'\n<Text className={styles.name} />\n```\n\n## 样式\n### [设计稿及尺寸单位](https://nervjs.github.io/taro/docs/size)\n- 默认`750px`为设计稿标准，可在`config/index`\n- `weapp` `px` $\\rightarrow$ `rpx`\n- `h5` `px` $\\rightarrow$ `rem`\n\n### 覆盖主题\n```scss\n// custom-variables.scss\n\n/* 改变主题变量，具体变量名可查看 taro-ui/dist/style/variables/default.scss 文件 */\n\n$color-brand: #6190E8;\n/* 引入 Taro UI 默认样式 */\n@import \"~taro-ui/dist/style/index.scss\";\n```\n### `css`预编译器\n> 默认支持`sass`\n\n### `styled-component`\n- 不支持, 有点难受\n\n---\n\n## 字体图标\n### `Iconfont`\n> 阿里图标\n#### 地址\n[Iconfont-阿里巴巴矢量图标库](https://www.iconfont.cn/manage/index?manage_type=myprojects&projectId=1707845)\n\n#### 插件\n- [GitHub - iconfont-cli/taro-iconfont-cli](https://github.com/iconfont-cli/taro-iconfont-cli)\n\n#### 配置\n- 将icon 添加到仓库\n- 获取`Symbol`链接\n- 更新`iconfont.json`\n\n```json\n{\n    \"symbol_url\": \"//at.alicdn.com/t/font_1707845_k4b717hruv.js\", // Symbol url\n    \"save_dir\": \"./src/components/iconfont\",\n    \"use_typescript\": false,\n    \"platforms\": \"*\",\n    \"use_rpx\": true,\n    \"trim_icon_prefix\": \"icon\",\n    \"default_icon_size\": 18,\n    \"component_name\": \"IconFont\"\n}\n\n// npx iconfont-taro \n// 更新 @/component/iconfont\n```\n\n#### 使用\n\n- `pages`\n\n```tsx\nimport Taro from \"@tarojs/taro\"\n\nimport IconFont from \"\"@/components/iconfont\"\n\nconst Check = () => {\n  return (\n    <IconFont name=\"check\" color=\"red\" size={30}/>\n  )\n}\n\nexport default Check;\n\n```\n\n```scss\n.icon {\n  &::before {\n    font-family: \"iconfont\";\n    content: \"\\e687\";\n    display: inline-block;\n    padding-right: 3px;\n    vertical-align: middle;\n    font-weight: 900;\n  }\n}\n```\n\n### `AtIcon`\n[Taro UI | Icon](https://taro-ui.aotu.io/#/docs/icon)\n\n---\n\n## 踩坑\n1. `SPA`页面间样式互相影响，采用`CSS Module`\n2. 获取小程序原生作用域`this.$scope`，使用命名函数或者`class`, 不能使用箭头函数\n3. 父组件向子组件传递函数，函数名以`on`开头\n4. `Taro.navigateBack`无法传参\n    - 场景\n      - 通用平面图拾取页面，拾取成功将数据返回上个页面\n    - 解决方案：\n      - 使用`getCurrentPages`\n      ```js\n        // this page\n        const pages = Taro.getCurrentPages()\n        const pre = pages[pages.length - 2]\n        pre.setData(myData)\n\n        // pre page\n        // useDidShow\n        const page = Taro.getCurrentPages().pop()\n        console.log(page.data)\n      ```\n      - 维护一个全局变量，如存在`Redux`\n5. `Object.fromEntries`支持不完善 \n\n\n### 转`wechat`微信小程序\n1. 获取坐标，转换为百度坐标系`BD09`，wx默认支持`WGS84`, 支持`GCJ02`\n    - [GitHub - hujiulong/gcoord: 地理坐标系转换工具，支持WGS84/GCJ02/BD09等常用坐标系互转](https://github.com/hujiulong/gcoord)\n2. 根据单位名称、地址、坐标实现地图导航\n    - 使用微信小程序第三方插件`腾讯位置服务路线规划`\n      - 注册：小程序管理后台 $\\rightarrow$ 设置 $\\rightarrow$ 第三方设置 $\\rightarrow$ 插件管理 $\\rightarrow$ 添加插件 $\\rightarrow$ 腾讯位置服务路线规划\n      - 申请腾讯位置服务申请的`KEY`\n      - 注册：`src/app.tsx`\n      ```ts\n      config = {\n        permission: {\n          'scope.userLocation': {\n            desc: '你的位置信息将用于创建单位的位置采集'\n          }\n        },\n        plugins: {\n          routePlan: {\n            version: \"1.0.5\",\n            provider: \"wx50b5593e81dd937a\" // 腾讯位置服务路线规划appid\n          }\n        },\n      }\n      ```\n      - 使用\n      ```tsx\n        Taro.requirePlugin('routePlan');\n        const key = KEY;  //使用在腾讯位置服务申请的key\n        const referer = MINI NAME;   //调用插件的app的名称\n        const endPoint = JSON.stringify({  //终点\n          name,\n          longitude,\n          latitude,\n        });\n        Taro.navigateTo({\n          url: 'plugin://routePlan/index?key=' + key + '&referer=' + referer + '&endPoint=' + endPoint\n        });\n      ```\n      - 能实现功能：步行、公交、驾车路径规划\n      - 缺点：不能进行导航\n    - 使用`wx.openLocation`拉起内置地图，点击`地图导航`按钮，拉起第三方地图软件\n3. 图片默认没有长宽锁定, 要使用`widthFix`\n\n### 转`H5`\n1. 多端开发不要使用`& > view {}` `& > image {}` `& > text {}`\n    - 突然接到将微信小程序转`h5`, 然后就炸了\n    - 没想到什么好方案，用的全局替换\n      - `& > view {}` $\\rightarrow$ `& > view, & > div {}`\n      - `& > image {}` $\\rightarrow$ `& > image, & > img {}`\n      - `& > text {}` $\\rightarrow$ `& > text, & > span {}`\n2. 默认没有头部导航\n\n\n### 转`alipay`支付宝小程序\n1. 获取元素高度\n```tsx\nonst query = Taro.createSelectorQuery();\nquery.select('.conatiner')\n  .boundingClientRect(function (rect) { \n    setbase({ img: e.detail, container: rect }) // wechat\n  })\n  .exec(rects => setbase({ img: e.detail, container: rects[0] })); // alipay\n```\n2. 图片上传使用`Taro.uploadFile`无法成功（微信小程序可行）使用`my.uploadFile`","tags":[],"folderPathname":"/font","data":{},"createdAt":"2020-08-07T02:51:31.069Z","updatedAt":"2020-08-07T02:51:38.921Z","trashed":false,"_id":"note:JmCuvMP81","_rev":"3-0fa81e982b7a1172c1b6ffa4239cca6a"}